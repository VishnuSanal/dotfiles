#!/bin/bash

MIN=0
MAX=$(cat '/sys/class/backlight/intel_backlight/max_brightness')

FILE="/sys/class/backlight/intel_backlight/brightness"

INTERNAL_CURRENT=$(cat "$FILE")

# initialize
if [ $# == 1 ] && ([ $1 == '-init' ] || [ $1 == '-i' ]); then
    sudo chmod a+rw $FILE
    sudo modprobe i2c-dev
    echo 'Done'
    exit
fi

# not enough params, print & exit
if [ ! "$1" ] || [ ! "$2" ]; then
    echo "Internal: "$(($INTERNAL_CURRENT * 100 / $MAX))"%"
    echo "Monitor : "$(ddcutil getvcp 10 | tail -n 1 | cut -d '=' -f 2 | cut -d ',' -f 1 | xargs)"%"
    exit
fi

# for the monitor
if ([ $1 == '-monitor' ] || [ $1 == '-m' ]) && [ $# -ge 2 ]; then

    MONITOR_CURRENT=$(ddcutil getvcp 10 | tail -n 1 | cut -d '=' -f 2 | cut -d ',' -f 1 | xargs)

    if [ ! "$3" ]; then
        DELTA=10
    else
        DELTA=$3
    fi

    if [ $2 == '-inc' ] || [ $2 == '-i' ]; then
        NEW=$(($MONITOR_CURRENT + $DELTA))
    elif [ $2 == '-dec' ] || [ $2 == '-d' ]; then
        NEW=$(($MONITOR_CURRENT - $DELTA))
    fi

    if [ $NEW -gt 100 ]; then
        NEW=100
    elif [ $NEW -lt 0 ]; then
        NEW=0
    fi

    ddcutil setvcp 10 $NEW # &>/dev/null

    # ddcutil setvcp 10 $2 &>/dev/null &
    exit
fi

NEW="$INTERNAL_CURRENT"

DELTA=$(($2 * $MAX / 100))

if [ $1 == '-inc' ] || [ $1 == '-i' ]; then
    NEW=$(($INTERNAL_CURRENT + $DELTA))
elif [ $1 == '-dec' ] || [ $1 == '-d' ]; then
    NEW=$(($INTERNAL_CURRENT - $DELTA))
fi

if [ $NEW -gt $MAX ]; then
    NEW=$MAX
elif [ $NEW -lt $MIN ]; then
    NEW=$MIN
fi

echo $NEW >"$FILE"

